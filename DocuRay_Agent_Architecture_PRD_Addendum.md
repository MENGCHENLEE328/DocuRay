# DocuRay 2.0 PRD 增补（权限与驻留 / LTR 评测 / 降级矩阵）

## 5. 权限与驻留

### 5.1 权限与目录策略
- 继承原则：索引面 = 可见面（严格透传源系统 ACL）
- 支持源：O365/SharePoint、GDrive、GitHub、Confluence
- ACL 透传矩阵：所有结果携带 `SourceACL(principal, scopes, tenant)` 摘要
- 边界案例：
  - 共享链接/过期权限：结果降级为“不可展示”，保留计数用于统计
  - 外部协作者：以租户白名单限制可见范围

### 5.2 租户与数据驻留
- 三层隔离：Enterprise / Department / Personal（索引仓、缓存、密钥全隔离）
- 驻留策略：本地优先；支持私有化/VPC 部署与离线模式
- 密钥管理：KMS/DPAPI/Keychain 统一抽象；密钥不落磁盘明文

### 5.3 连接器健康度面板
- 指标：采集延迟、队列积压、回溯补抓次数、变更窗口
- 回溯策略：USN/FSEvents 丢事件 → 轻扫（路径差异）/重扫（哈希）

---

## 6. LTR 评测与回放

### 6.1 Learning-to-Rank 离线集
- 标注规则：“问 → 页/行/片段”一对多；构造难负例
- 指标：nDCG@K、P@1；设定回归门槛与基线
- 版本管理：数据集与特征 schema 打 tag，评测结果入库

### 6.2 A/B 与查询回放
- 在线收集点击/纠错对，驱动 pairwise 学习
- 回放工具：支持重放 24h 查询请求，离线复现排序变动
- 安全：回放遵守 ACL，敏感片段脱敏

---

## 7. 错误与降级矩阵

| 组件 | 主要故障 | 诊断信号 | 降级策略 |
|---|---|---|---|
| MCP-Vector | 超时/不可达 | 请求>95P、错误率 | 回退 chromadb，本地向量缓存 |
| MCP-PDF | 解析失败 | 解析错误、空页 | 降级 OCR/纯文本提取 |
| Router-ONNX | 模型缺失 | 加载失败 | 规则路由 + 模式库 |
| Early-Stop | 配置异常 | 阈值缺省 | 使用默认阈值并记录告警 |
| 索引损坏 | 读段失败 | 校验和失败 | 一键重建：段重排+元数据恢复 |

注：所有降级在 Explain 面板标注“降级来源与影响范围”。

